#!/bin/sh

# Small script called in Makefile to prepare systemd to only build udev.
# This exists merely to keep the Makefile clean.

VERSION="254"

sed -i	-e 's/GROUP="render"/GROUP="video"/' \
	-e 's/GROUP="sgx", //' systemd-"${VERSION}"/rules.d/50-udev-default.rules.in
sed '/systemd-sysctl/s/^/#/' -i systemd-"${VERSION}"/rules.d/99-systemd.rules.in

mkdir -p systemd-"${VERSION}"/build

cd systemd-"${VERSION}"/build && \
	meson setup \
		--prefix=/usr \
		--buildtype=release \
		-Dmode=release \
		-Ddev-kvm-mode=0660 \
		-Dlink-udev-shared=false && \
		cd ../../

cd systemd-"${VERSION}" && \
	ninja udevadm systemd-hwdb \
	$(grep -o -E "^build (src/libudev|src/udev|rules.d|hwdb.d)[^:]*" \
	build.ninja | awk '{ print $2 }') \
	$(realpath libudev.so --relative-to .) && \
	rm rules.d/90-vconsole.rules && \
	cd ..
